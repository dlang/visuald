
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en-US">

<!--
	Copyright (c) 1999-2013 by Digital Mars
	All Rights Reserved Written by Walter Bright
	http://digitalmars.com
  -->

<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="keywords" content="D programming language" />
<meta name="description" content="D Programming Language" />
<title>Garbage Collection - D Programming Language</title>
<link rel="stylesheet" href="css/codemirror.css" />
<link rel="stylesheet" type="text/css" href="css/style.css" />
<link rel="stylesheet" type="text/css" href="css/print.css" media="print" />
<link rel="shortcut icon" href="favicon.ico" />

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script src="/js/codemirror.js"></script>
<script src="/js/run-main-website.js" type="text/javascript"></script>
<script src="/js/d.js"></script>
<script src="/js/run.js" type="text/javascript"></script>

<script type="text/javascript">
function bodyLoad()
{
	var links = document.getElementById("navigation").getElementsByTagName("a");
	for (var i = 0; i < links.length; i++)
	{
		var url = "/" + links[i].getAttribute("href");
		if (window.location.href.match(url + "\x24") == url)
		{
			var cls = links[i].getAttribute("class");
			links[i].setAttribute("class", cls ? cls + " active" : "active");
			break;
		}
	}
}
</script>
</head>

<body onLoad='bodyLoad()'>

<div id="top">
	<div id="search-box">
		<form method="get" action="http://google.com/search">
			<img src="/images/search-left.gif" width="11" height="22" /><input id="q" name="q" /><input type="image" id="search-submit" name="submit" src="/images/search-button.gif" />
			<input type="hidden" id="domains" name="domains" value="dlang.org" />
			<input type="hidden" id="sourceid" name="sourceid" value="google-search" />
			<div id="search-dropdown">
				<select id="sitesearch" name="sitesearch" size="1">
					<option value="dlang.org">Entire D Site</option>
					<option value="dlang.org/phobos">Library Reference</option>
					<option value="digitalmars.com/d/archives">Newsgroup Archives</option>
				</select>
			</div>
		</form>
	</div>
	<div id="header">
		<a id="d-language" href="/">
		<img id="logo" width="125" height="95" border="0" alt="D Logo" src="/images/dlogo.png">
		D Programming Language</a>
	</div>
</div>

<!--Generated by Ddoc from garbage.dd-->



<div id="navigation">
  

<div class="navblock">
<h2><a href="index.html" title="D Programming Language">D </a></h2>
<ul>	<li><a href="overview.html" title="D language overview">Overview</a></li>

	<li><a href="comparison.html" title="D feature list">Features</a></li>

	<li><a href="download.html" title="Download a D compiler">Downloads &amp; Tools</a></li>

	<li><a href="changelog.html" title="History of changes to D">Change Log</a></li>
	<li><a href="bugstats.php" title="D issue and bug tracking system">Bug Tracker</a></li>
	<li><a href="faq.html" title="Frequently Asked Questions">FAQ</a></li>

	<li><a href="appendices.html">Appendices</a></li>
	<li><a href="acknowledgements.html" title="Thank-you to these people who have helped with D">Acknowledgments</a></li>
	<li><a href="sitemap.html" title="Documents on this site, indexed alphabetically">Sitemap</a></li>
	<li><a href="http://digitalmars.com/d/1.0/index.html" title="D Programming Language 1.0">D1 Home</a></li>
</ul>
    </div>


<div class="navblock">
<h2>Documentation</h2>
<ul>    <li><a href="http://www.amazon.com/exec/obidos/ASIN/0321635361/classicempire">Book</a>
</li>
	<li><a href="http://www.informit.com/articles/article.aspx?p=1381876">&nbsp;<font size=-1><span style="visibility: hidden">3</span>1.&nbsp;Tutorial</font></a></li>
	<li><a href="http://www.informit.com/articles/article.aspx?p=1609144">&nbsp;<font size=-1>13.&nbsp;Concurrency</font></a></li>

	<li><a href="language-reference.html">Language Reference</a>

    <div class="navblock">
<ul>	<li><a href="lex.html">Lexical</a></li>
	<li><a href="module.html">Modules</a></li>
	<li><a href="declaration.html">Declarations</a></li>
	<li><a href="type.html">Types</a></li>
	<li><a href="property.html">Properties</a></li>
	<li><a href="attribute.html">Attributes</a></li>
	<li><a href="pragma.html">Pragmas</a></li>
	<li><a href="expression.html">Expressions</a></li>
	<li><a href="statement.html">Statements</a></li>
	<li><a href="arrays.html">Arrays</a></li>
	<li><a href="hash-map.html">Associative Arrays</a></li>
	<li><a href="struct.html">Structs &amp; Unions</a></li>
	<li><a href="class.html">Classes</a></li>
	<li><a href="interface.html">Interfaces</a></li>
	<li><a href="enum.html">Enums</a></li>
	<li><a href="const3.html">Const and Immutable</a></li>
	<li><a href="function.html">Functions</a></li>
	<li><a href="operatoroverloading.html">Operator Overloading</a></li>
	<li><a href="template.html">Templates</a></li>
	<li><a href="template-mixin.html">Template Mixins</a></li>
	<li><a href="dbc.html">Contracts</a></li>
	<li><a href="version.html">Conditional Compilation</a></li>
	<li><a href="simd.html">Vector Extensions</a></li>
	<li><a href="traits.html">Traits</a></li>
	<li><a href="errors.html">Handling errors</a></li>
	<li><a href="unittest.html">Unit Tests</a></li>
	<li><a href="garbage.html">Garbage Collection</a></li>
	<li><a href="float.html">Floating Point</a></li>
	<li><a href="iasm.html">Inline Assembler</a></li>
	<li><a href="ddoc.html">Documentation Comments</a></li>
	<li><a href="interfaceToC.html">Interfacing To C</a></li>
	<li><a href="cpp_interface.html">Interfacing To C++</a></li>
	<li><a href="portability.html">Portability Guide</a></li>
	<li><a href="entity.html">Named Character Entities</a></li>
	<li><a href="memory-safe-d.html">Memory Safe D Spec</a></li>
	<li><a href="abi.html">Application Binary Interface</a></li>
    </ul>
</div>
</li>
	<li><a href="phobos/index.html">Library Reference</a></li>
	<li><a href="visuald/StartPage.html">Visual D</a></li>
	<li><a href="howtos.html" title="Helps for using D">How-tos</a></li>

	<li><a href="articles.html">Articles</a></li>
</ul>
    </div>


<div class="navblock">
<h2>Community</h2>
<ul>	<li><a href="http://forum.dlang.org/" title="User forums">Forums</a></li>
	<li><a href="http://github.com/D-Programming-Language" title="D on github">GitHub</a></li>
	<li><a href="http://wiki.dlang.org" title="Wiki for the D Programming Language">Wiki</a></li>
	<li><a href="http://wiki.dlang.org/Review_Queue" title="Queue of current and upcoming standard library additions">Review Queue</a></li>
	<li><a href="http://twitter.com/#search?q=%23d_lang" title="#d_lang on twitter.com">Twitter</a></li>
	<li><a href="http://digitalmars.com/d/dlinks.html" title="External D related links">Links</a></li>
	
</ul>
    </div>


  
<div id="translate" class="tool">Translate this page:
	<div id="google_translate_element"></div><script type="text/javascript">
	function googleTranslateElementInit() {
	  new google.translate.TranslateElement({
	    pageLanguage: 'en',
	    autoDisplay: false,
	    layout: google.translate.TranslateElement.InlineLayout.SIMPLE
	  }, 'google_translate_element');
	}
	</script>
<script type="text/javascript" src="http://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
</div>

</div><!--/navigation-->
<div id="content" class='hyphenate'>
  
<div id="tools">
	<!--span id="lastupdate">Last update Wed Oct 02 13:49:23 2013

</span-->
	<span class="tip">
		<a href="https://github.com/D-Programming-Language/dlang.org/edit/master/garbage.dd" class="button">Improve this page</a>
		<span>
			Quickly fork, edit online, and submit a pull request for this page.
			Requires a signed-in GitHub account. This works well for small changes.
			If you'd like to make larger changes you may want to consider using
			local clone.
		</span>
	</span>
	<span class="tip">
		<a href="http://wiki.dlang.org/DocComments/Garbage" class="button">Page wiki</a>
		<span>
			View or edit the community-maintained wiki page associated with this page.
		</span>
	</span>
</div>

  <h1>Garbage Collection</h1>
  
	<p>D is a fully garbage collected language. That means that it is never
	necessary
	to free memory. Just allocate as needed, and the garbage collector will
	periodically return all unused memory to the pool of available memory.
	</p>

	<p>C and C++ programmers accustomed to explicitly managing memory
	allocation and
	deallocation will likely be skeptical of the benefits and efficacy of
	garbage collection. Experience both with new projects written with
	garbage collection in mind, and converting existing projects to garbage
	collection shows that:
	</p>

	<ul>
	<li>Garbage collected programs are often faster. This is
	counterintuitive, but the reasons are:

	<ul>	    <li>Reference counting is a common solution to solve explicit
	    memory allocation problems. The code to implement the increment and
	    decrement operations whenever assignments are made is one source
	    of slowdown. Hiding it behind smart pointer classes doesn't help
	    the speed. (Reference counting methods are not a general solution
	    anyway, as circular references never get deleted.)
	    </li>

	    <li>Destructors are used to deallocate resources acquired by an object.
	    For most classes, this resource is allocated memory.
	    With garbage collection, most destructors then become empty and
	    can be discarded entirely.
	    </li>

	    <li>All those destructors freeing memory can become significant when
	    objects are allocated on the stack. For each one, some mechanism must
	    be established so that if an exception happens, the destructors all
	    get called in each frame to release any memory they hold. If the
	    destructors become irrelevant, then there's no need to set up special
	    stack frames to handle exceptions, and the code runs faster.
	    </li>

	    <li>Garbage collection kicks in only when memory gets tight. When
	    memory is not tight, the program runs at full speed and does not
	    spend any time tracing and freeing memory.
	    </li>

	    <li>Garbage collected programs do not suffer from gradual deterioration
	    due to an accumulation of memory leaks.
	    </li>
	</ul>
	</li>

	<li>Garbage collectors reclaim unused memory, therefore they do not suffer
	from "memory leaks" which can cause long running applications to gradually
	consume more and more memory until they bring down the system. GC programs
	have longer term stability.
	</li>

	<li>Garbage collected programs have fewer hard-to-find pointer bugs. This
	is because there are no dangling references to freed memory. There is no
	code to explicitly manage memory, hence no bugs in such code.
	</li>

	<li>Garbage collected programs are faster to develop and debug, because
	there's no need for developing, debugging, testing, or maintaining the
	explicit deallocation code.
	</li>

	</ul>

	<p>Garbage collection is not a panacea. There are some downsides:
	</p>

	<ul>
	<li>It is not easily predictable when a collection gets run, so the
	program can arbitrarily pause.
	</li>

	<li>The time it takes for a collection to run is not bounded. While in
	practice it is very quick, this cannot be guaranteed.
	</li>

	<li>All threads other than the collector thread must be halted while
	the collection is in progress.
	</li>

	<li>Garbage collectors can keep around some memory that an explicit
	deallocator would not.
	</li>

	<li>Garbage collection should be implemented as a basic operating
	system
	kernel service. But since it is not, garbage collecting programs must
	carry around with them the garbage collection implementation. While this
	can be a shared library, it is still there.
	</li>
	</ul>

	<p>These constraints are addressed by techniques outlined
	in <a href="memory.html">Memory Management</a>.
	</p>

<h2>How Garbage Collection Works</h2>

	<p>The GC works by:</p>

	<ol>	<li>Stopping all other threads than the thread currently trying to
	allocate GC memory.</li>

	<li>&lsquo;Hijacking&rsquo; the current thread for GC work.</li>

	<li>Scanning all &lsquo;root&rsquo; memory ranges for pointers into
	GC allocated memory.</li>

	<li>Recursively scanning all allocated memory pointed to by
	roots looking for more pointers into GC allocated memory.</li>

	<li>Freeing all GC allocated memory that has no active pointers
	to it and do not need destructors to run.</li>

	<li>Queueing all unreachable memory that needs destructors to run.</li>

	<li>Resuming all other threads.</li>

	<li>Running destructors for all queued memory.</li>

	<li>Freeing any remaining unreachable memory.</li>

	<li>Returning the current thread to whatever work it was doing.</li>
	</ol>

<h2>Interfacing Garbage Collected Objects With Foreign Code</h2>

	<p>The garbage collector looks for roots in:</p>
	<ol>	<li>the static data segment</li>
	<li>the stacks and register contents of each thread</li>
	<li>the TLS (thread-local storage) areas of each thread</li>
	<li>any roots added by core.memory.GC.addRoot() or core.memory.GC.addRange()</li>
	</ol>

	<p>If the only pointer to an object
	is held outside of these areas, then the collector will miss it and free the
	memory.
	</p>

	<p>To avoid this from happening, either</p>

	<ul>	<li>maintain a pointer to the object in an area the collector does scan
	for pointers;</li>

	<li>add a root where a pointer to the object is stored using core.memory.GC.addRoot()
	or core.memory.GC.addRange().</li>

	<li>reallocate and copy the object using the foreign code's storage
	allocator
	or using the C runtime library's malloc/free.
	</li>
	</ul>

<h2>Pointers and the Garbage Collector</h2>

	<p>Pointers in D can be broadly divided into two categories: Those that
	point to garbage collected memory, and those that do not. Examples
	of the latter are pointers created by calls to C's malloc(), pointers
	received from C library routines, pointers to static data,
	pointers to objects on the stack, etc. For those pointers, anything
	that is legal in C can be done with them.
	</p>

	<p>For garbage collected pointers and references, however, there are
	some
	restrictions. These restrictions are minor, but they are intended
	to enable the maximum flexibility in garbage collector design.
	</p>

	<p>Undefined behavior:</p>

	<ul>
	<li>Do not xor pointers with other values, like the
	xor pointer linked list trick used in C.
	</li>

	<li>Do not use the xor trick to swap two pointer values.
	</li>

	<li>Do not store pointers into non-pointer variables using casts and
	other tricks.

<pre class="d_code"><span class="notranslate"><span class="d_keyword">void</span>* p;
...
<span class="d_keyword">int</span> x = <span class="d_keyword">cast</span>(<span class="d_keyword">int</span>)p;   <span class="d_comment">// error: undefined behavior
</span></span></pre>

	The garbage collector does not scan non-pointer fields for GC pointers.
	</li>

	<li>Do not take advantage of alignment of pointers to store bit flags
	in the low order bits:

<pre class="d_code"><span class="notranslate">p = <span class="d_keyword">cast</span>(<span class="d_keyword">void</span>*)(<span class="d_keyword">cast</span>(<span class="d_keyword">int</span>)p | 1);  <span class="d_comment">// error: undefined behavior
</span></span></pre>
	</li>

	<li>Do not store into pointers values that may point into the
	garbage collected heap:

<pre class="d_code"><span class="notranslate">p = <span class="d_keyword">cast</span>(<span class="d_keyword">void</span>*)12345678;   <span class="d_comment">// error: undefined behavior
</span></span></pre>

	A copying garbage collector may change this value.
	</li>

	<li>Do not store magic values into pointers, other than <span class="notranslate"><span class="d_inlinecode donthyphenate">null</span></span>.
	</li>

	<li>Do not write pointer values out to disk and read them back in
	again.
	</li>

	<li>Do not use pointer values to compute a hash function. A copying
	garbage collector can arbitrarily move objects around in memory,
	thus invalidating
	the computed hash value.
	</li>

	<li>Do not depend on the ordering of pointers:

<pre class="d_code"><span class="notranslate"><span class="d_keyword">if</span> (p1 &lt; p2)  <span class="d_comment">// error: undefined behavior
</span>  ...
</span></pre>
	since, again, the garbage collector can move objects around in
	memory.
	</li>

	<li>Do not add or subtract an offset to a pointer such that the result
	points outside of the bounds of the garbage collected object originally
	allocated.

<pre class="d_code"><span class="notranslate"><span class="d_keyword">char</span>* p = <span class="d_keyword">new</span> <span class="d_keyword">char</span>[10];
<span class="d_keyword">char</span>* q = p + 6; <span class="d_comment">// ok
</span>q = p + 11;      <span class="d_comment">// error: undefined behavior
</span>q = p - 1;       <span class="d_comment">// error: undefined behavior
</span></span></pre>
	</li>

	<li>Do not misalign pointers if those pointers may
	point into the GC heap, such as:

<pre class="d_code"><span class="notranslate"><span class="d_keyword">struct</span> Foo {
<span class="d_keyword">align</span> (1):
  <span class="d_keyword">byte</span> b;
  <span class="d_keyword">char</span>* p;  <span class="d_comment">// misaligned pointer
</span>}
</span></pre>

	Misaligned pointers may be used if the underlying hardware
	supports them <b>and</b> the pointer is never used to point
	into the GC heap.
	</li>

	<li>Do not use byte-by-byte memory copies to copy pointer values.
	This may result in intermediate conditions where there is
	not a valid pointer, and if the gc pauses the thread in such a
	condition, it can corrupt memory.
	Most implementations of <span class="notranslate"><span class="d_inlinecode donthyphenate">memcpy()</span></span> will work since the
	internal implementation of it does the copy in aligned chunks
	greater than or equal to the pointer size, but since this kind of
	implementation is not guaranteed by the C standard, use
	<span class="notranslate"><span class="d_inlinecode donthyphenate">memcpy()</span></span> only with extreme caution.
	</li>

	<li>Do not have pointers in a struct instance that point back
	to the same instance. The trouble with this is if the instance
	gets moved in memory, the pointer will point back to where it
	came from, with likely disastrous results.
	</li>

	</ul>

	<p>Things that are reliable and can be done:</p>

	<ul>
	<li>Use a union to share storage with a pointer:

<pre class="d_code"><span class="notranslate"><span class="d_keyword">union</span> U { <span class="d_keyword">void</span>* ptr; <span class="d_keyword">int</span> value }
</span></pre>
	</li>

	<li>A pointer to the start of a garbage collected object need not
	be maintained if a pointer to the interior of the object exists.

<pre class="d_code"><span class="notranslate"><span class="d_keyword">char</span>[] p = <span class="d_keyword">new</span> <span class="d_keyword">char</span>[10];
<span class="d_keyword">char</span>[] q = p[3..6];
<span class="d_comment">// q is enough to hold on to the object, don't need to keep
</span><span class="d_comment">// p as well.
</span></span></pre>
	</li>
	</ul>

	<p>One can avoid using pointers anyway for most tasks. D provides
	features
	rendering most explicit pointer uses obsolete, such as reference
	objects,
	dynamic arrays, and garbage collection. Pointers
	are provided in order to interface successfully with C APIs and for
	some low level work.
	</p>

<h2>Working with the Garbage Collector</h2>

	<p>Garbage collection doesn't solve every memory deallocation problem.
	For
	example, if a pointer to a large data structure is kept, the garbage
	collector cannot reclaim it, even if it is never referred to again. To
	eliminate this problem, it is good practice to set a reference or
	pointer to an object to null when no longer needed.
	</p>

	<p>This advice applies only to static references or references embedded
	inside other objects. There is not much point for such stored on the
	stack to be nulled because new stack frames are initialized anyway.
	</p>

<h2>Object Pinning and a Moving Garbage Collector</h2>

	<p>Although D does not currently use a moving garbage collector, by following
	the rules listed above one can be implemented. No special action is required
	to pin objects. A moving collector will only move objects for which there
	are no ambiguous references, and for which it can update those references.
	All other objects will be automatically pinned.
	</p>

<h2>D Operations That Involve the Garbage Collector</h2>

	<p>Some sections of code may need to avoid using the garbage collector.
	The following constructs may allocate memory using the garbage collector:
	</p>

	<ul>	<li><a href="expression.html#NewExpression"><i>NewExpression</i></a></li>
	<li>Array appending</li>
	<li>Array concatenation</li>
	<li>Array literals (except when used to initialize static data)</li>
	<li>Associative array literals</li>
	<li>Any insertion, removal, or lookups in an associative array</li>
	<li>Extracting keys or values from an associative array</li>
		<li>Taking the address of (i.e. making a delegate to) a nested function that
	 accesses variables in an outer scope</li>
	<li>A function literal that accesses variables in an outer scope</li>
	
	<li>An <a href="expression.html#AssertExpression"><i>AssertExpression</i></a> that fails its condition</li>
	</ul>

<h2>References</h2>

	<ul>	<li><a href="http://en.wikipedia.org/wiki/Garbage_collection_%28computer_science%29">Wikipedia</a></li>
	<li><a href="http://www.iecc.com/gclist/GC-faq.html">GC FAQ</a></li>
	<li><a href="ftp://ftp.cs.utexas.edu/pub/garbage/gcsurvey.ps">Uniprocessor Garbage Collector Techniques</a></li>
	<li><a href="http://www.amazon.com/exec/obidos/ASIN/0471941484/classicempire">Garbage Collection : Algorithms for Automatic Dynamic Memory Management</a>
</li>
	</ul>


  
<div id="google_ad">
<!-- Google ad -->
<script type="text/javascript"><!--
/**/google_ad_client = "pub-5628673096434613";
/**/google_ad_width = 728;
/**/google_ad_height = 90;
/**/google_ad_format = "728x90_as";
/**/google_ad_channel ="3651639259";
/**/google_page_url = document.location;
//--></script>
<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</div>

</div><!--/content-->





<div id="footernav">
<a href="http://forum.dlang.org/" title="User Forums">Forums</a> |
<a href="http://wiki.dlang.org/DocComments/Garbage" title="Read/write comments and feedback">Comments</a> |
<a href="http://digitalmars.com/advancedsearch.html" title="Search Digital Mars web site">Search</a> |
<a href="download.html" title="Download D">Downloads</a> |
<a href="/">Home</a>
</div>
<div id="copyright">

Copyright &copy; 1999-2013 by Digital Mars &reg;, All Rights Reserved
 |
Page generated by <a href="ddoc.html">Ddoc</a> on Wed Oct 02 13:49:23 2013


</div>

</body>
</html>

