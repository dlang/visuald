
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en-US">

<!--
	Copyright (c) 1999-2013 by Digital Mars
	All Rights Reserved Written by Walter Bright
	http://digitalmars.com
  -->

<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="keywords" content="D programming language" />
<meta name="description" content="D Programming Language" />
<title>Porting 32 Bit Code to 64 Bits - D Programming Language</title>
<link rel="stylesheet" href="css/codemirror.css" />
<link rel="stylesheet" type="text/css" href="css/style.css" />
<link rel="stylesheet" type="text/css" href="css/print.css" media="print" />
<link rel="shortcut icon" href="favicon.ico" />

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script src="/js/codemirror.js"></script>
<script src="/js/run-main-website.js" type="text/javascript"></script>
<script src="/js/d.js"></script>
<script src="/js/run.js" type="text/javascript"></script>

<script type="text/javascript">
function bodyLoad()
{
	var links = document.getElementById("navigation").getElementsByTagName("a");
	for (var i = 0; i < links.length; i++)
	{
		var url = "/" + links[i].getAttribute("href");
		if (window.location.href.match(url + "\x24") == url)
		{
			var cls = links[i].getAttribute("class");
			links[i].setAttribute("class", cls ? cls + " active" : "active");
			break;
		}
	}
}
</script>
</head>

<body onLoad='bodyLoad()'>

<div id="top">
	<div id="search-box">
		<form method="get" action="http://google.com/search">
			<img src="/images/search-left.gif" width="11" height="22" /><input id="q" name="q" /><input type="image" id="search-submit" name="submit" src="/images/search-button.gif" />
			<input type="hidden" id="domains" name="domains" value="dlang.org" />
			<input type="hidden" id="sourceid" name="sourceid" value="google-search" />
			<div id="search-dropdown">
				<select id="sitesearch" name="sitesearch" size="1">
					<option value="dlang.org">Entire D Site</option>
					<option value="dlang.org/phobos">Library Reference</option>
					<option value="digitalmars.com/d/archives">Newsgroup Archives</option>
				</select>
			</div>
		</form>
	</div>
	<div id="header">
		<a id="d-language" href="/">
		<img id="logo" width="125" height="95" border="0" alt="D Logo" src="/images/dlogo.png">
		D Programming Language</a>
	</div>
</div>

<!--Generated by Ddoc from 32-64-portability.dd-->



<div id="navigation">
  

<div class="navblock">
<h2><a href="index.html" title="D Programming Language">D </a></h2>
<ul>	<li><a href="overview.html" title="D language overview">Overview</a></li>

	<li><a href="comparison.html" title="D feature list">Features</a></li>

	<li><a href="download.html" title="Download a D compiler">Downloads &amp; Tools</a></li>

	<li><a href="changelog.html" title="History of changes to D">Change Log</a></li>
	<li><a href="bugstats.php" title="D issue and bug tracking system">Bug Tracker</a></li>
	<li><a href="faq.html" title="Frequently Asked Questions">FAQ</a></li>

	<li><a href="appendices.html">Appendices</a></li>
	<li><a href="acknowledgements.html" title="Thank-you to these people who have helped with D">Acknowledgments</a></li>
	<li><a href="sitemap.html" title="Documents on this site, indexed alphabetically">Sitemap</a></li>
	<li><a href="http://digitalmars.com/d/1.0/index.html" title="D Programming Language 1.0">D1 Home</a></li>
</ul>
    </div>


<div class="navblock">
<h2>Documentation</h2>
<ul>    <li><a href="http://www.amazon.com/exec/obidos/ASIN/0321635361/classicempire">Book</a>
</li>
	<li><a href="http://www.informit.com/articles/article.aspx?p=1381876">&nbsp;<font size=-1><span style="visibility: hidden">3</span>1.&nbsp;Tutorial</font></a></li>
	<li><a href="http://www.informit.com/articles/article.aspx?p=1609144">&nbsp;<font size=-1>13.&nbsp;Concurrency</font></a></li>

	<li><a href="language-reference.html">Language Reference</a></li>
	<li><a href="phobos/index.html">Library Reference</a></li>
	<li><a href="howtos.html" title="Helps for using D">How-tos</a>

    <div class="navblock">
<ul>		<li><a href="windows.html" title="D implementation for 32 bit Windows systems">D for Win32</a></li>
		<li><a href="dll.html" title="Writing 32 bit Windows DLLs in D">Win32 DLLs in D</a></li>
		<li><a href="COM.html" title="Windows COM Programming">COM Programming</a></li>
		<li><a href="32-64-portability.html" title="Porting 32 Bit Code to 64 Bits">Porting to 64 Bits</a></li>
		<li><a href="htomodule.html" title="converting C .h header files to D modules">C .h to D Modules</a></li>
		<li><a href="http://digitalmars.com/techtips/index.html" title="Programming tips">Tech Tips</a></li>
</ul>
</div>

</li>

	<li><a href="articles.html">Articles</a></li>
</ul>
    </div>


<div class="navblock">
<h2><a href="http://rainers.github.io/visuald/visuald/StartPage.html
">Visual D</a></h2>
<ul></ul>
    </div>


<div class="navblock">
<h2>Community</h2>
<ul>	<li><a href="http://forum.dlang.org/" title="User forums">Forums</a></li>
	<li><a href="http://github.com/D-Programming-Language" title="D on github">GitHub</a></li>
	<li><a href="http://wiki.dlang.org" title="Wiki for the D Programming Language">Wiki</a></li>
	<li><a href="http://wiki.dlang.org/Review_Queue" title="Queue of current and upcoming standard library additions">Review Queue</a></li>
	<li><a href="http://twitter.com/#search?q=%23d_lang" title="#d_lang on twitter.com">Twitter</a></li>
	<li><a href="http://digitalmars.com/d/dlinks.html" title="External D related links">Links</a></li>
	
</ul>
    </div>


  
<div id="translate" class="tool">Translate this page:
	<div id="google_translate_element"></div><script type="text/javascript">
	function googleTranslateElementInit() {
	  new google.translate.TranslateElement({
	    pageLanguage: 'en',
	    autoDisplay: false,
	    layout: google.translate.TranslateElement.InlineLayout.SIMPLE
	  }, 'google_translate_element');
	}
	</script>
<script type="text/javascript" src="http://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
</div>

</div><!--/navigation-->
<div id="content" class='hyphenate'>
  
<div id="tools">
	<!--span id="lastupdate">Last update Sun Sep 22 15:36:54 2013

</span-->
	<span class="tip">
		<a href="https://github.com/D-Programming-Language/dlang.org/edit/master/32-64-portability.dd" class="button">Improve this page</a>
		<span>
			Quickly fork, edit online, and submit a pull request for this page.
			Requires a signed-in GitHub account. This works well for small changes.
			If you'd like to make larger changes you may want to consider using
			local clone.
		</span>
	</span>
	<span class="tip">
		<a href="http://wiki.dlang.org/DocComments/32To64" class="button">Page wiki</a>
		<span>
			View or edit the community-maintained wiki page associated with this page.
		</span>
	</span>
</div>

  <h1>Porting 32 Bit Code to 64 Bits</h1>
  
	<p>Although D is designed to make it easy to port code between
	32 and 64 bit modes, being a systems programming language,
	dependencies can creep in. This guide points out what changes
	between the two.
	</p>

<h2>Versions</h2>
	<p>Not all code can be made portable between 32 and 64 bits,
	and must be versioned. The following works:
	</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">version</span> (X86)
    ... 32 bit code ...
<span class="d_keyword">else</span> <span class="d_keyword">version</span> (X86_64)
    ... 64 bit code ...
<span class="d_keyword">else</span>
    <span class="d_keyword">static</span> <span class="d_keyword">assert</span>(<span class="d_string">"unsupported target"</span>)
</span></pre>

	<p>It is best to write versioning in that manner to give a compile
	time error on a new target, rather than guessing in advance what, for example,
	a 64 bit ARM target might require.
	Experience shows that guesses about how an unfamiliar platform might work
	always get it wrong.
	Save those decisions for when one is actually working on a 64 bit ARM.
	</p>


<h2>Size Changes</h2>

	<p>The size of pointers and references will increase from 4
	to 8 bytes. The <span class="notranslate"><span class="d_inlinecode donthyphenate">size_t</span></span> alias moves from <span class="notranslate"><span class="d_inlinecode donthyphenate">uint</span></span> to
	<span class="notranslate"><span class="d_inlinecode donthyphenate">ulong</span></span>, and the <span class="notranslate"><span class="d_inlinecode donthyphenate">ptrdiff_t</span></span> alias moves from <span class="notranslate"><span class="d_inlinecode donthyphenate">int</span></span>
	to <span class="notranslate"><span class="d_inlinecode donthyphenate">long</span></span>.
	</p>

	<p>The sizes of compound types based on these will also increase.
	This includes dynamic arrays, associative arrays, delegates,
	and class references.
	</p>


<h2>Structs</h2>

	<p>The size of the struct and the alignment of its fields
	will change, in order to match the C ABI of the equivalent
	C struct.
	</p>


<h2>Classes</h2>

	<p>The size of the class and the alignment of its fields
	will change, in order to match the alignment most suitable
	for the 64 bit mode, and in order to accommodate the increased
	size of pointers and references.
	</p>


<h2>printf</h2>

	<p>Since <span class="notranslate"><span class="d_inlinecode donthyphenate">printf</span></span> is a C function, it follows C typing rules.
	This can have consequences for using them with D types.
	</p>

	<table border=1 cellpadding=4 cellspacing=0>	<tr><th rowspan=2>D Type</th> <th colspan=2>printf format</th></tr>
	<tr><th scope="col">32 bit</th> <th scope="col">64 bit</th></tr>
	<tr><td><i>T</i>*</td> <td>%p</td> <td>%p</td></tr>
	<tr><td>long</td> <td>%lld</td> <td>%d</td></tr>
	<tr><td>ulong</td> <td>%llu</td> <td>%u</td></tr>
	<tr><td>ptrdiff_t</td> <td>%td</td> <td>%td</td></tr>
	<tr><td>size_t</td> <td>%zu</td> <td>%zu</td></tr>
	</table>

	<p>For 32 bit code, it was common to use the <span class="notranslate"><span class="d_inlinecode donthyphenate">%.*s</span></span> format
	to print strings. This relied on the 32 bit C ABI interpreting the
	components of a dynamic array as separate length and pointer arguments.
	64 bit parameter passing is different, and so the length and pointer
	should be done explicitly:
	</p>

<pre class="d_code"><span class="notranslate">string s;
...
printf(<span class="d_string">"s = '%.*s'\n"</span>, s);               <span class="d_comment">// 32 bit only
</span>printf(<span class="d_string">"s = '%.*s'\n"</span>, s.length, s.ptr); <span class="d_comment">// 32 and 64 bit
</span></span></pre>


<h2>Inline Assembly</h2>

	<p>Naturally, inline assembly for 32 bit code won't work for 64 bit code.
	The versioning statements to use are:
	</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">version</span> (D_InlineAsm_X86)
    ... 32 bit assembler ...
<span class="d_keyword">version</span> (D_InlineAsm_X86_64)
    ... 64 bit assembler ...
<span class="d_keyword">else</span>
    <span class="d_keyword">static</span> <span class="d_keyword">assert</span>(<span class="d_string">"unsupported target"</span>);
</span></pre>

	<p>The 64 bit inline assembler uses the syntax found in the Intel
	and AMD instruction set references.
	</p>


<h2>Variadic Arguments</h2>

	<p>How variadic arguments work in 64 bits is radically different from
	32 bits. They are not a simple array on the stack. You will need to use
	the functions and templates in <span class="notranslate"><span class="d_inlinecode donthyphenate">std.c.stdarg</span></span> to access them.
	</p>




  
<div id="google_ad">
<!-- Google ad -->
<script type="text/javascript"><!--
/**/google_ad_client = "pub-5628673096434613";
/**/google_ad_width = 728;
/**/google_ad_height = 90;
/**/google_ad_format = "728x90_as";
/**/google_ad_channel ="3651639259";
/**/google_page_url = document.location;
//--></script>
<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</div>

</div><!--/content-->





<div id="footernav">
<a href="http://forum.dlang.org/" title="User Forums">Forums</a> |
<a href="http://wiki.dlang.org/DocComments/32To64" title="Read/write comments and feedback">Comments</a> |
<a href="http://digitalmars.com/advancedsearch.html" title="Search Digital Mars web site">Search</a> |
<a href="download.html" title="Download D">Downloads</a> |
<a href="/">Home</a>
</div>
<div id="copyright">

Copyright &copy; 1999-2013 by Digital Mars &reg;, All Rights Reserved
 |
Page generated by <a href="ddoc.html">Ddoc</a> on Sun Sep 22 15:36:54 2013


</div>

</body>
</html>

